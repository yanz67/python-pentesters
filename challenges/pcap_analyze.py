from scapy.all import *
from scapy.layers.dns import DNS
from scapy.layers.inet import IP
from scapy.layers.http import Raw, HTTP, HTTPRequest


def dns_packet_counts(raw_packets, hostname):
    dns_packet_count = 0
    dns_google = 0
    for raw_packet in raw_packets:
        if raw_packet.haslayer(DNS):
            dns_packet_count += 1
            if raw_packet.qd.qname.decode("utf-8").find('google.com') != -1:
                dns_google += 1
    return dns_packet_count, dns_google


def count_visits(raw_packets, source):
    hosts = set()
    for raw_packet in raw_packets:
        if raw_packet[IP].src == source and raw_packet.haslayer('HTTPRequest') and raw_packet(
                HTTPRequest).Method == b'GET':
            hosts.add(raw_packet[HTTPRequest].host)
    return len(hosts)


def http_packet_counts(raw_packets, str_to_find):
    found_count = 0
    for raw_packet in raw_packets:
        if raw_packet.haslayer('HTTP'):
            if raw_packet.show(dump=True).find(str_to_find) > -1:
                found_count += 1
    return found_count


packets = rdpcap('sample.pcap')
print(dns_packet_counts(packets, 'google.com'))
print(http_packet_counts(packets, 'user'))
print(count_visits(packets, '192.168.252.128'))
