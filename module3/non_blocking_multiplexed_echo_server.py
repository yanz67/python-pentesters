#!/usr/bin/env python3

import socket
import select


def init_server() -> socket:
    tcp_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    tcp_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    port = 8004
    tcp_socket.bind(('0.0.0.0', port))
    tcp_socket.listen(10)
    print("Server started and waiting for connections")
    return tcp_socket


def process_connections(server: socket):
    connections = []
    while True:
        read, write, ex = select.select([server] + connections, [], [])
        for s in read:
            if s is server:
                (client, (ip, port)) = server.accept()
                print(f'Received a connection from IP {ip} on port {port}')
                print("Starting ECHO output...")
                connections.append(client)
            else:
                data = s.recv(256)
                if not data:
                    connections.remove(s)
                    print("Closing connection")
                    s.close()
                else:
                    ip, port = s.getpeername()
                    print(f'Received {data.decode("utf-8").rstrip()} from IP {ip} on port {port}')
                    s.send(data)


if __name__ == '__main__':
    multiplexed_server = init_server()
    process_connections(multiplexed_server)
